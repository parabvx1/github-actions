name: jira_check
on: 
  push:
    branches:
      - jira-checker
  pull_request:
    branches:
      - jira-checker
      
env:
  atlassian_user: brytboy@github.com
  atlassian_key: 9MGgvvK0k38Sw3zYqDMmA485
  atlassian_url: team-1624462930934.atlassian.net
      
jobs:
  issue-validation:
    runs-on: ubuntu-latest
    steps:
      - id: issue-val
        run: |
          COMMIT_MESSAGE=${{ github.event.head_commit.message }}
          COMMIT_MESSAGE=${COMMIT_MESSAGE#*\[}
          ISSUE=${COMMIT_MESSAGE%\]*}
          ISSUE_JSON=$(curl -u "${{ env.atlassian_user }}:${{ env.atlassian_key }}" -H "Content-Type:application/json" "https://${{ env.atlassian_url }}/rest/api/2/issue/${ISSUE}")
          ISSUE_STATUS=${{ fromJson($ISSUE_JSON).fields.status.name }}
              
          if [ $ISSUE_STATUS == 'To Do' ] || [ $ISSUE_STATUS == 'In Progress' ]
          then
            curl -X POST -u "${{ env.atlassian_user }}:${{ env.atlassian_key }}" -H "Accept:application/json" -H "Content-Type:application/json" -d '{"body":"New GitHub work has been committed towards this issue: https://github.com/BrytBoyCorp/github-actions/${GITHUB_SHA}"}' "https://${{ env.atlassian_url }}/rest/api/2/issue/${ISSUE}/comment"
          else
            echo "Commit message did not contain a valid JIRA issue key in the expected format: [JIRA-KEY] -- failing operation."
          fi
             
